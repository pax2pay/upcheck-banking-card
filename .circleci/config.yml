version: 2.1

default: &default
  working_directory: ~/repo

orbs:
  node: circleci/node@7.2.1
  slack: circleci/slack@6.1.2

commands:
  prepare:
    description: "Prepare working directory"
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies-
      - run: npm install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}

  test-pax2pay-banking-card-api:
    description: "Pax2pay banking card API tests"
    steps:
      - prepare
      - run: mkdir -p workspace
      - run:
          name: Run Pax2pay banking card API tests
          command: |
            # We use if/else to swallow the error initially so we can save artifacts
            if npm run test -- --no-color --reporter=junit --outputFile=workspace/junit.xml; then
              echo 'export TESTS_PASS=true' >> $BASH_ENV
            else
              echo 'export TESTS_PASS=false' >> $BASH_ENV
            fi
      - store_test_results:
          path: workspace/junit.xml
      - persist_to_workspace:
          root: workspace
          paths:
            - output
            - junit.xml
      - run:
          name: Return Exit Code
          command: |
            # NOW we fail the build if tests failed, triggering the on_fail step later
            if [ "$TESTS_PASS" == "false" ]; then
              exit 1
            fi

  notify-on-failure:
    description: "Sends a main alert and threads the error details"
    steps:
      - run:
          name: Parse XML and Notify Slack (Threaded)
          when: on_fail
          command: |
            node -e '
              const fs = require("fs");
              const https = require("https");
              function sendSlack(payload) {
                return new Promise((resolve, reject) => {
                  const req = https.request(process.env.SLACK_WEBHOOK, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                  }, (res) => {
                    let data = "";
                    res.on("data", (chunk) => data += chunk);
                    res.on("end", () => resolve(JSON.parse(data || "{}")));
                  });
                  req.on("error", reject);
                  req.write(JSON.stringify(payload));
                  req.end();
                });
              }
              async function run() {
                try {
                  let slackCodeBlock = "No specific error details found in XML.";
                  try {
                    const xml = fs.readFileSync("workspace/junit.xml", "utf8");
                    const failureMatches = xml.match(/<failure[^>]*>([\s\S]*?)<\/failure>/g);
                    if (failureMatches) {
                       const errors = failureMatches.slice(0, 5).map(failTag => {
                          let text = failTag.replace(/<[^>]+>/g, "").trim(); 
                          return text.replace(/&quot;/g, "\"").replace(/&apos;/g, "'").replace(/&lt;/g, "<").replace(/&gt;/g, ">");
                       });
                       slackCodeBlock = errors.join("\n\n-------------------\n\n");
                       if (failureMatches.length > 5) slackCodeBlock += `\n\n... +${failureMatches.length - 5} more`;
                    }
                  } catch (e) { 
                    console.log("XML read error (using fallback):", e.message); 
                  }
                  console.log("Sending Parent Message...");
                  const parentRes = await sendSlack({
                    blocks: [
                      {
                        type: "header",
                        text: { type: "plain_text", text: `ðŸš¨ Tests Failed: ${process.env.CIRCLE_JOB}`, emoji: true }
                      },
                      {
                        type: "section",
                        text: { type: "mrkdwn", text: `*<${process.env.CIRCLE_BUILD_URL}|View Full CircleCI Logs>*` }
                      }
                    ]
                  });
                  if (!parentRes.ok) throw new Error("Failed to send parent message: " + JSON.stringify(parentRes));
                  console.log("Sending Thread Reply...");
                  await sendSlack({
                    thread_ts: parentRes.ts, 
                    text: "Error Details", 
                    blocks: [
                      {
                        type: "section",
                        text: { type: "mrkdwn", text: "```\n" + slackCodeBlock + "\n```" }
                      }
                    ]
                  });
                  
                  console.log("Done!");
                } catch (e) {
                  console.error("Script failed:", e);
                }
              }
              run();
            '

jobs:
  pax2pay-banking-card-api-mute:
    executor: node/default
    <<: *default
    steps:
      - test-pax2pay-banking-card-api
      - attach_workspace:
          at: workspace
    - notify-on-failure
  pax2pay-banking-card-api-quiet:
    executor: node/default
    <<: *default
    steps:
      - test-pax2pay-banking-card-api
      - attach_workspace:
          at: workspace
      - notify-on-failure
  pax2pay-banking-card-api-notify:
    executor: node/default
    <<: *default
    steps:
      - test-pax2pay-banking-card-api
      - attach_workspace:
          at: workspace
      - notify-on-failure
      - slack/notify:
          event: pass
          template: basic_success_1

workflows:
  pax2pay-banking-card:
    triggers:
      - schedule:
          cron: "2,12,22,42,52 * * * *"
          filters:
            branches:
              only: master
      - schedule:
          cron: "32 00-12 * * *"
          filters:
            branches:
              only: master
      - schedule:
          cron: "32 14-23 * * *"
          filters:
            branches:
              only: master
    jobs:
      - pax2pay-banking-card-api-quiet
  daily:
    triggers:
      - schedule:
          cron: "32 13 * * *"
          filters:
            branches:
              only: master
    jobs:
      - pax2pay-banking-card-api-notify
  build:
    jobs:
      - pax2pay-banking-card-api-mute
