version: 2.1
orbs:
  node: circleci/node@5.1.0
  slack: circleci/slack@4.12.5
parameters:
  node-version:
    type: string
    default: "16.14"
executors:
  default-node:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    working_directory: ~/repo
jobs:
  test-pax2pay-banking-card-api:
    executor: default-node
    parameters:
      notification_mode:
        type: enum
        enum: ["mute", "quiet", "notify"]
        default: "mute"
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run Pax2pay banking card API tests
          command: |
             set -o pipefail
             npm run test -- --maxWorkers=2 --no-color --reporter=default --reporter=junit --outputFile=reports/junit.xml | tee test_output.txt
      - store_test_results:
          path: reports
      - run:
          name: Prepare Slack Log
          when: on_fail
          command: |
            # Grab the last 40 lines (The Vitest/Jest summary graph)
            # Clean it up for JSON
            TAIL_LOG=$(tail -n 40 test_output.txt | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}')
            echo "export SLACK_LOGS=\"$TAIL_LOG\"" >> $BASH_ENV
      - when:
          condition:
            or:
              - equal: [ quiet, << parameters.notification_mode >> ]
              - equal: [ notify, << parameters.notification_mode >> ]
          steps:
            - slack/notify:
                event: fail
                mentions: '@here'
                custom: |
                  {
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "Tests Failed :rotating_light:",
                          "emoji": true
                        }
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "```${SLACK_LOGS}```"
                        }
                      },
                      {
                        "type": "actions",
                        "elements": [
                          {
                            "type": "button",
                            "text": {
                              "type": "plain_text",
                              "text": "View Dashboard Graphs"
                            },
                            "url": "${CIRCLE_BUILD_URL}",
                            "style": "primary"
                          }
                        ]
                      }
                    ]
                  }

      - when:
          condition:
             equal: [ notify, << parameters.notification_mode >> ]
          steps:
            - slack/notify:
                event: pass
                template: basic_success_1
workflows:
  build:
    jobs:
      - test-pax2pay-banking-card-api:
          notification_mode: mute
  pax2pay-banking-card:
    triggers:
      - schedule:
          cron: "7,17,27,47,57 * * * *"
          filters:
            branches:
              only: master
      - schedule:
          cron: "37 00-12,14-23 * * *"
          filters:
            branches:
              only: master
    jobs:
      - test-pax2pay-banking-card-api:
          notification_mode: quiet
  daily:
    triggers:
      - schedule:
          cron: "37 13 * * *"
          filters:
            branches:
              only: master
    jobs:
      - test-pax2pay-banking-card-api:
          notification_mode: notify
